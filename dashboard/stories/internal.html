<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>قسم القصة السريرية - داخلية عامة / جراحة - طبيبي</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://js.puter.com/v2/"></script>
  <style>
    /* CSS Variables للـThemes (مُحدثة وموحدة مع story.html) */
    :root {
      --bg-color: #f5f7fa;
      --card-bg: #ffffff;
      --text-color: #333;
      --secondary-text: #666;
      --border-color: #d1d5db;
      --primary-blue: #1e88e5;
      --button-bg: #1e88e5;
      --button-hover: #1565c0;
      --secondary-button-bg: #f1f1f1;
      --secondary-button-hover: #ddd;
      --success-green: #4caf50;
      --shadow-light: rgba(0,0,0,0.05);
      --icon-color: #1e88e5;
      --animated-text-color: #60a5fa;
    }

    [data-theme="dark"] {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #e0e0e0;
      --secondary-text: #b0b0b0;
      --border-color: #4b5563;
      --primary-blue: #0d47a1;
      --button-bg: #0d47a1;
      --button-hover: #1565c0;
      --secondary-button-bg: #2a2a2a;
      --secondary-button-hover: #3a3a3a;
      --success-green: #388e3c;
      --shadow-light: rgba(255,255,255,0.05);
      --icon-color: #90caf9;
      --animated-text-color: #a5b4fc;
    }

    body {
      margin: 0;
      font-family: 'Tajawal', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background-color 0.3s, color 0.3s;
    }
  /* نافذة الأسئلة التفاعلية */
.symptom-description {
    background: rgba(30, 136, 229, 0.1);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-right: 4px solid var(--primary-blue);
    color: var(--text-color);
}

.questions-container {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 10px;
}

.question-item {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.question-item h4 {
    margin: 0 0 10px 0;
    color: var(--primary-blue);
    font-size: 15px;
}

.question-options {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.option {
    padding: 8px 15px;
    background: var(--secondary-button-bg);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 14px;
}

.option:hover {
    background: var(--secondary-button-hover);
}

.option.selected {
    background: var(--primary-blue);
    color: white;
    border-color: var(--primary-blue);
}

.option.multiple-selected {
    background: var(--success-green);
    color: white;
    border-color: var(--success-green);
}

.question-input {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--card-bg);
    color: var(--text-color);
    margin-top: 5px;
}

.question-input:focus {
    border-color: var(--primary-blue);
    outline: none;
}

.range-container {
    margin-top: 10px;
}

.range-value {
    text-align: center;
    font-weight: bold;
    color: var(--primary-blue);
    margin-top: 5px;
}

.questions-controls {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
}

/* تحسينات للوضع الدارك */
[data-theme="dark"] .symptom-description {
    background: rgba(30, 136, 229, 0.2);
}

[data-theme="dark"] .option {
    background: var(--secondary-button-bg);
}
  /* نافذة الموسوعة */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: var(--card-bg);
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: var(--primary-blue);
}

.close {
    color: var(--text-color);
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: var(--primary-blue);
}

.modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
}

.symptoms-list {
    display: grid;
    gap: 10px;
    margin-top: 15px;
}

.symptom-item {
    padding: 15px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.symptom-item:hover {
    border-color: var(--primary-blue);
    transform: translateY(-2px);
}

.symptom-item h4 {
    margin: 0 0 5px 0;
    color: var(--primary-blue);
}

.symptom-item p {
    margin: 0;
    color: var(--secondary-text);
    font-size: 14px;
}

    a { text-decoration: none; }

    /* الهيدر (مدمج من story.html مع تعديل: زر رجوع بدون نص) */
    header {
      background: var(--primary-blue);
      color: #fff;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background-color 0.3s;
      box-shadow: 0 2px 8px var(--shadow-light);
    }

    header .logo {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    header h1 {
      font-size: 24px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #fff;
    }

    header small {
      font-size: 13px;
      color: #e3f2fd;
      margin-top: 2px;
    }

    /* زر الرجوع (بدون نص، فقط أيقونة) */
    #back-btn {
      font-size: 26px;
      background: var(--secondary-button-bg);
      border: none;
      color: var(--text-color);
      cursor: pointer;
      border-radius: 8px;
      padding: 10px;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: inherit;
      font-weight: bold;
    }

    #back-btn:hover { 
      background: var(--secondary-button-hover);
    }

    /* الفوتر (مدمج من story.html) */
    footer {
      text-align: center;
      padding: 15px;
      background: var(--primary-blue);
      color: #fff;
      font-size: 14px;
      transition: background-color 0.3s;
      margin-top: auto; /* لدفع الفوتر للأسفل */
    }

    main {
      flex: 1;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    .wrap {
      max-width: 1000px;
      margin: 0 auto;
      padding: 16px;
    }

    /* باقي CSS من internal.html (مع تعديلات للتوافق مع المتغيرات الجديدة) */
    .header-card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 6px 20px var(--shadow-light);
      padding: 20px;
      margin-bottom: 20px;
      transition: background 0.3s ease;
      text-align: center;
    }

    .step-card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 6px 20px var(--shadow-light);
      padding: 20px;
      margin-bottom: 20px;
      transition: background 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
      display: none; /* مخفي افتراضيًا */
    }

    .step-card.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      margin: 0 0 10px;
      font-size: 24px;
      color: var(--primary-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    h2 {
      margin: 0 0 15px;
      font-size: 18px;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 8px;
    }

    h3 { margin: 15px 0 10px; font-size: 16px; color: var(--primary-blue); }

    h2 i, h3 i { color: var(--icon-color); }

    .grid {
      display: grid;
      gap: 12px;
    }

    .cols-2 { grid-template-columns: 1fr 1fr; }
    .cols-3 { grid-template-columns: 1fr 1fr 1fr; }

    label {
      display: block;
      font-size: 14px;
      margin-bottom: 5px;
      color: var(--text-color);
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 14px;
      box-sizing: border-box;
      background: var(--card-bg) !important;
      color: var(--text-color) !important;
      transition: border-color 0.3s ease;
    }

    input::placeholder, textarea::placeholder {
      color: var(--secondary-text) !important;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-blue);
      outline: none;
    }

    textarea { min-height: 80px; resize: vertical; }

    .checkbox-group { display: flex; align-items: center; gap: 10px; margin: 10px 0; }

    .checkbox-group input[type="checkbox"] { width: auto; }

    .conditional { 
      display: none; 
      margin-top: 10px; 
      padding: 10px; 
      border: 1px dashed var(--border-color); 
      border-radius: 6px; 
      background: rgba(0,0,0,0.02);
    }

    .conditional.show { display: block; }

    [data-theme="dark"] .conditional { 
      background: rgba(255,255,255,0.05);
    }

    .btn {
      padding: 10px 16px;
      background: var(--button-bg);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin: 5px;
    }

    .btn:hover { background: var(--button-hover); }

    .btn-secondary { background: var(--secondary-button-bg); color: var(--text-color); }

    .btn-secondary:hover { background: var(--secondary-button-hover); }

    .btn-wizard {
      margin: 20px 5px 0;
      padding: 12px 24px;
      font-size: 16px;
      width: auto;
    }

    .wizard-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      border-top: 1px solid var(--border-color);
      padding-top: 15px;
    }

    .list-section {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }

    .list-item {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      padding: 10px;
      background: rgba(0,0,0,0.02);
      border-radius: 6px;
    }

    .list-item input, .list-item select, .list-item textarea { flex: 1; }

    [data-theme="dark"] .list-item { background: rgba(255,255,255,0.05); }

    .remove-btn {
      background: #ef4444;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .remove-btn:hover { background: #dc2626; }

    .add-btn { margin-top: 10px; }

    /* النص المتحرك في Header-card (موجود داخل main) */
    .animated-phrase {
      text-align: center;
      font-size: 16px;
      font-weight: 500;
      color: var(--animated-text-color);
      margin: 15px 0;
      padding: 10px 20px;
      border-radius: 25px;
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.1), rgba(96, 165, 250, 0.05));
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    [data-theme="dark"] .animated-phrase { background: linear-gradient(135deg, rgba(165, 180, 252, 0.1), rgba(165, 180, 252, 0.05)); }

    .animated-phrase.show {
      opacity: 1;
      animation: fadeGlow 3s ease-in-out infinite;
    }

    @keyframes fadeGlow {
      0%, 100% { opacity: 0.6; transform: scale(1); text-shadow: 0 0 5px rgba(96, 165, 250, 0.3); }
      50% { opacity: 1; transform: scale(1.02); text-shadow: 0 0 20px rgba(96, 165, 250, 0.6); }
    }

    /* Progress Bar */
    .progress-bar {
      margin: 20px 0;
      background: var(--border-color);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary-blue);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Responsive */
    @media (max-width: 768px) {
      header { padding: 10px 15px; }
      header h1 { font-size: 20px; }
      #back-btn { font-size: 18px; padding: 8px; }
      main { padding: 10px; }
      .wrap { padding: 10px; margin: 0; }
      .cols-2, .cols-3 { grid-template-columns: 1fr; }
      .list-item { flex-direction: column; gap: 5px; }
      .animated-phrase { font-size: 14px; padding: 8px 15px; }
      .checkbox-group { flex-direction: column; align-items: flex-start; }
      .wizard-controls { flex-direction: column; gap: 10px; }
      .btn-wizard { width: 100%; justify-content: center; }
      footer { padding: 10px; font-size: 12px; }
    }

    /* Dark Mode تحسينات إضافية */
    [data-theme="dark"] .info-boxes div,
    [data-theme="dark"] .card,
    [data-theme="dark"] .step-card,
    [data-theme="dark"] .header-card {
      background: var(--card-bg);
    }

    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
      background: var(--card-bg) !important;
      color: var(--text-color) !important;
      border-color: var(--border-color) !important;
    }

    [data-theme="dark"] input::placeholder,
    [data-theme="dark"] textarea::placeholder {
      color: var(--secondary-text) !important;
    }

    [data-theme="dark"] input::-webkit-input-placeholder,
    [data-theme="dark"] textarea::-webkit-input-placeholder {
      color: var(--secondary-text) !important;
    }

    [data-theme="dark"] input:-ms-input-placeholder,
    [data-theme="dark"] textarea:-ms-input-placeholder {
      color: var(--secondary-text) !important;
    }

    [data-theme="dark"] input[readonly],
    [data-theme="dark"] input[readonly="readonly"] {
      background: var(--card-bg) !important;
      color: var(--text-color) !important;
    }

    [data-theme="dark"] #back-btn {
      background: var(--secondary-button-bg);
      color: var(--text-color);
    }

    [data-theme="dark"] #back-btn:hover {
      background: var(--secondary-button-hover);
    }

    [data-theme="dark"] .btn-secondary { color: var(--text-color); }


  </style>
</head>
<body data-theme="light">

  <!-- الهيدر (مدمج من story.html مع تعديل الزر) -->
  <header>
    <div class="logo">
      <h1><i class="fas fa-stethoscope"></i> طبيبي</h1>
      <small>أول تطبيق ذكاء اصطناعي طبي في سوريا</small>
    </div>
    <button id="back-btn">
      <i class="fas fa-arrow-left"></i>
    </button>
  </header>

  <main>
    <div class="wrap">
      <!-- Header-card الأصلي (يبقى كعنوان الصفحة داخل main) -->
      <div class="header-card">
        <h1><i class="fas fa-user-md"></i> القصة السريرية العامة (باطنية/جراحة)</h1>
        <div class="animated-phrase" id="animatedPhrase"></div>
      </div>

      <!-- شريط التقدم -->
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <!-- الخطوات (كما هي) -->
      <!-- Step 1: الملف الشخصي -->
      <div class="step-card active" id="step1">
        <h2><i class="fas fa-user"></i> 1. الملف الشخصي للمريض</h2>
        <div class="grid cols-2">
          <div>
            <label>الاسم الكامل *</label>
            <input type="text" id="fullName" required>
          </div>
          <div>
            <label>الجنس *</label>
            <select id="gender" required>
              <option value="">اختر</option>
              <option value="ذكر">ذكر</option>
              <option value="أنثى">أنثى</option>
            </select>
          </div>
        </div>
        <div class="grid cols-2">
          <div>
            <label>العمر *</label>
            <input type="number" id="age" min="0" required>
          </div>
          <div>
            <label>الحالة الاجتماعية *</label>
            <select id="maritalStatus" onchange="toggleChildren()" required>
              <option value="">اختر</option>
              <option value="متزوج">متزوج</option>
              <option value="أعزب">أعزب</option>
              <option value="مطلق">مطلق</option>
              <option value="أرمل">أرمل</option>
            </select>
          </div>
        </div>
        <div class="grid cols-2">
          <div id="childrenField" style="display:none;">
            <label>عدد الأولاد</label>
            <input type="number" id="childrenCount" min="0">
          </div>
          <div>
            <label>عنوان السكن *</label>
            <textarea id="address" required></textarea>
          </div>
        </div>
        <div>
          <label>المهنة</label>
          <input type="text" id="occupation">
        </div>
      </div>

      <!-- Step 2: الشكاية الرئيسية -->
      <div class="step-card" id="step2">
        <h2><i class="fas fa-exclamation-triangle"></i> 2. الشكاية الرئيسية وتفصيلها</h2>
        <div id="complaintsList" class="list-section"></div>
        <!-- بعد زر "إضافة شكاية" -->
        <button class="btn" onclick="openSymptomsLibrary()" style="margin-top: 10px;">
          <i class="fas fa-book-medical"></i> استعراض الأعراض من الموسوعة
        </button>
      </div>

      <!-- Step 3: السوابق المرضية والجراحية -->
      <div class="step-card" id="step3">
        <h2><i class="fas fa-history"></i> 3. السوابق المرضية والجراحية</h2>
        <h3>السوابق المرضية</h3>
        <div id="medicalHistoryList" class="list-section"></div>
        <button class="btn add-btn" onclick="addMedicalHistory()"><i class="fas fa-plus"></i> إضافة سابقة مرضية</button>
        <h3>السوابق الجراحية</h3>
        <div id="surgicalHistoryList" class="list-section"></div>
        <button class="btn add-btn" onclick="addSurgicalHistory()"><i class="fas fa-plus"></i> إضافة سابقة جراحية</button>
      </div>

      <!-- Step 4: السوابق الدوائية والتحسسية -->
      <div class="step-card" id="step4">
        <h2><i class="fas fa-pills"></i> 4. السوابق الدوائية والتحسسية</h2>
        <h3>السوابق الدوائية</h3>
        <div id="drugHistoryList" class="list-section"></div>
        <button class="btn add-btn" onclick="addDrugHistory()"><i class="fas fa-plus"></i> إضافة سابقة دوائية</button>
        <h3>السوابق التحسسية</h3>
        <div id="allergyHistoryList" class="list-section"></div>
        <button class="btn add-btn" onclick="addAllergyHistory()"><i class="fas fa-plus"></i> إضافة تحسس</button>
      </div>

      <!-- Step 5: السوابق العائلية والعادات -->
      <div class="step-card" id="step5">
        <h2><i class="fas fa-users"></i> 5. السوابق العائلية والعادات والغرائز</h2>
        <h3>السوابق العائلية</h3>
        <div id="familyHistoryList" class="list-section"></div>
        <button class="btn add-btn" onclick="addFamilyHistory()"><i class="fas fa-plus"></i> إضافة سابقة عائلية</button>
        <h3>العادات والغرائز</h3>
        <div class="grid cols-3">
          <div>
            <label>التدخين</label>
            <select id="smoking" onchange="toggleHabitDetails('smokingDetails')">
              <option value="">اختر</option>
              <option value="لا">لا</option>
              <option value="سابق">سابق</option>
              <option value="حالي">حالي</option>
            </select>
            <div id="smokingDetails" class="conditional">
              <label>المدة والكمية</label>
              <input type="text" id="smokingQuantity" placeholder="مثال: 10 سجائر/يوم لـ5 سنوات">
            </div>
          </div>
          <div>
            <label>الكحول</label>
            <select id="alcohol" onchange="toggleHabitDetails('alcoholDetails')">
              <option value="">اختر</option>
              <option value="لا">لا</option>
              <option value="سابق">سابق</option>
              <option value="حالي">حالي</option>
            </select>
            <div id="alcoholDetails" class="conditional">
              <label>المدة والكمية</label>
              <input type="text" id="alcoholQuantity" placeholder="مثال: كأس/أسبوع لـ3 سنوات">
            </div>
          </div>
          <div>
            <label>المخدرات</label>
            <select id="drugs" onchange="toggleHabitDetails('drugsDetails')">
              <option value="">اختر</option>
              <option value="لا">لا</option>
              <option value="سابق">سابق</option>
              <option value="حالي">حالي</option>
            </select>
            <div id="drugsDetails" class="conditional">
              <label>المدة والكمية</label>
              <input type="text" id="drugsQuantity" placeholder="مثال: نوع، كمية، مدة">
            </div>
          </div>
        </div>
      </div>

      <!-- Step 6: التقارير الطبية (محدث: بدون حقل رفع ملف) -->
      <div class="step-card" id="step6">
        <h2><i class="fas fa-file-medical"></i> 6. التقارير الطبية</h2>
        <div id="reportsList" class="list-section"></div>
        <button class="btn add-btn" onclick="addReport()"><i class="fas fa-plus"></i> إضافة تقرير</button>
      </div>

      <!-- Step 7: العلامات الحيوية -->
      <div class="step-card" id="step7">
        <h2><i class="fas fa-heartbeat"></i> 7. العلامات الحيوية</h2>
        <div class="grid cols-2">
          <div>
            <label>هل ترغب بإدخال العلامات الحيوية؟ *</label>
            <select id="vitalsOptIn" onchange="toggleVitalsSection()" required>
              <option value="">اختر</option>
              <option value="نعم">نعم</option>
              <option value="لا">لا</option>
            </select>
          </div>
        </div>
        <div id="vitalsSection" class="conditional" style="display:none; margin-top: 20px;">
          <div class="grid cols-2">
            <div>
              <label>الضغط الشرياني (مثال: 120/80)</label>
              <input type="text" id="bloodPressure">
            </div>
            <div>
              <label>النبض (بالدقيقة)</label>
              <input type="number" id="pulse" min="0">
            </div>
          </div>
          <div class="grid cols-2">
            <div>
              <label>الحرارة (درجة مئوية)</label>
              <input type="number" id="temperature" step="0.1" min="0">
            </div>
            <div>
              <label>معدل التنفس (بالدقيقة)</label>
              <input type="number" id="respiratoryRate" min="0">
            </div>
          </div>
          <div class="grid cols-2">
            <div>
              <label>الوزن (كغ)</label>
              <input type="number" id="weight" min="0" oninput="calculateBMI()">
            </div>
            <div>
              <label>الطول (سم)</label>
              <input type="number" id="height" min="0" oninput="calculateBMI()">
            </div>
          </div>
          <div>
            <label>مؤشر كتلة الجسم (BMI)</label>
            <input type="number" id="bmi" readonly style="background: var(--card-bg); cursor: not-allowed;">
          </div>
        </div>
        <p style="text-align: center; font-size: 16px; color: var(--primary-blue); margin-top: 20px;">يمكنك الآن إرسال القصة السريرية للحصول على التشخيصات التفريقية.</p>
      </div>

      <!-- Step 8: الخطوة النهائية (للرجوع إليها إذا لزم الأمر) -->
      <div class="step-card final-step" id="step8">
        <h2><i class="fas fa-check-circle"></i> إكمال النموذج</h2>
        <p style="text-align: center; font-size: 18px; color: var(--primary-blue);">لقد أكملت جميع الخطوات! يمكنك الآن بدء قصة سريرية جديدة.</p>
        <div style="text-align: center; margin-top: 20px;">
          <button class="btn" onclick="resetForm()" style="font-size: 18px; padding: 15px 30px;"><i class="fas fa-plus"></i> بدء قصة سريرية جديدة</button>
        </div>
      </div>

      <!-- أزرار التنقل -->
      <div class="wizard-controls" id="wizardControls">
        <button class="btn btn-secondary btn-wizard" id="prevBtn" onclick="prevStep()" style="display: none;"><i class="fas fa-arrow-right"></i> السابق</button>
        <button class="btn btn-wizard" id="nextBtn" onclick="nextStep()"><i class="fas fa-arrow-left"></i> التالي</button>
      </div>

      <!-- أزرار الخطوة النهائية -->
      <div class="wizard-controls" id="finalControls" style="display: none;">
        <button class="btn btn-secondary btn-wizard" onclick="prevStep()"><i class="fas fa-arrow-right"></i> السابق</button>
        <button class="btn btn-wizard" onclick="resetForm()"><i class="fas fa-plus"></i> بدء قصة سريرية جديدة</button>
      </div>

      <!-- قسم عرض النتائج (جدول التشخيصات التفريقية) - داخل wrap لأفضل تكامل -->
      <div id="resultsSection" class="step-card" style="display: none; padding: 20px; margin: 20px 0; background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow);">
        <h2 style="text-align: center; color: var(--primary-blue);"><i class="fas fa-table"></i> التشخيصات التفريقية</h2>
        <div id="resultsTable" style="overflow-x: auto; margin-top: 15px;"></div>
      </div>
    </div>
  </main>

  <!-- الفوتر (مدمج من story.html) -->
  <footer>© جميع الحقوق محفوظة لـ Kasp-ai</footer>

  <script>
    // معالج زر الرجوع (يعود إلى story.html إذا لم يكن تاريخ)
    document.addEventListener('DOMContentLoaded', () => {
      const backBtn = document.getElementById('back-btn');
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          if (window.history.length > 1) {
            window.history.back();
          } else {
            window.location.href = '../story.html'; // العودة إلى story.html
          }
        });
      }
    });

    // النص المتحرك في header-card
    const phrases = [
      "<i class='fas fa-stethoscope'></i> جمع القصة السريرية بدقة وكفاءة",
      "<i class='fas fa-user-md'></i> باطنية وجراحة في نموذج واحد",
      "<i class='fas fa-file-alt'></i> تتبع كامل للسوابق والشكايات",
      "<i class='fas fa-shield-alt'></i> سرية وأمان للبيانات الطبية"
    ];
    let phraseIndex = 0;
    const animatedPhrase = document.getElementById("animatedPhrase");
    function showPhrase() {
      animatedPhrase.classList.remove("show");
      setTimeout(() => {
        animatedPhrase.innerHTML = phrases[phraseIndex];
        animatedPhrase.classList.add("show");
        phraseIndex = (phraseIndex + 1) % phrases.length;
      }, 500);
    }
    setInterval(showPhrase, 4000);
    showPhrase();

    // Wizard Logic
    const totalSteps = 8;
    let currentStep = 1;
    let storySubmitted = false; // متغير للتحقق إذا تم إرسال القصة

    function updateProgress() {
      const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
    }

    function showStep(step) {
      for (let i = 1; i <= totalSteps; i++) {
        const stepEl = document.getElementById(`step${i}`);
        if (stepEl) {
          stepEl.classList.remove('active');
        }
      }
      document.getElementById(`step${step}`).classList.add('active');
      currentStep = step;

      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const wizardControls = document.getElementById('wizardControls');
      const finalControls = document.getElementById('finalControls');

      wizardControls.style.display = 'none';
      finalControls.style.display = 'none';

      if (step === 1) {
        prevBtn.style.display = 'none';
        wizardControls.style.display = 'flex';
        if (storySubmitted) {
          nextBtn.innerHTML = '<i class="fas fa-plus"></i> بدء قصة سريرية جديدة';
          nextBtn.onclick = resetForm;
        } else {
          nextBtn.innerHTML = '<i class="fas fa-arrow-left"></i> التالي';
          nextBtn.onclick = nextStep;
        }
      } else if (step === 7) {
        prevBtn.style.display = 'inline-flex';
        wizardControls.style.display = 'flex';
        if (storySubmitted) {
          nextBtn.innerHTML = '<i class="fas fa-plus"></i> بدء قصة سريرية جديدة';
          nextBtn.onclick = resetForm;
        } else {
          nextBtn.innerHTML = '<i class="fas fa-paper-plane"></i> إرسال القصة السريرية';
          nextBtn.onclick = sendStoryFromStep7;
        }
      } else if (step === totalSteps) {
        finalControls.style.display = 'flex';
        // الزر الأيمن الآن للبدء الجديد
      } else {
        prevBtn.style.display = 'inline-flex';
        wizardControls.style.display = 'flex';
        nextBtn.innerHTML = '<i class="fas fa-arrow-left"></i> التالي';
        nextBtn.onclick = nextStep;
      }

      updateProgress();
    }

    function validateCurrentStep() {
      if (currentStep === 1) {
        const requiredFields = ['fullName', 'gender', 'age', 'maritalStatus', 'address'];
        for (let field of requiredFields) {
          if (!document.getElementById(field).value.trim()) {
            alert('يرجى ملء جميع الحقول المطلوبة في هذه الخطوة.');
            return false;
          }
        }
      } else if (currentStep === 7) {
        if (!document.getElementById('vitalsOptIn').value.trim()) {
          alert('يرجى اختيار خيار للعلامات الحيوية.');
          return false;
        }
      }
      return true;
    }

    // تعديل nextStep للتحقق من Step 7
    function nextStep() {
      if (validateCurrentStep() && currentStep < 7) { // حتى Step 6
        showStep(currentStep + 1);
      } else if (currentStep === 7 && validateCurrentStep()) {
        // لا تنتقل، بل أرسل مباشرة (سيتم التعامل في onclick)
      }
    }

    // دالة إرسال من Step 7
    function sendStoryFromStep7() {
      if (!validateCurrentStep()) return;
      
      // حفظ محلي إذا لزم
      const formData = collectFormData();
      console.log('Story Sent from Step 7:', formData);
      
      alert('جاري إرسال القصة السريرية للتحليل...');
      sendToPuter();
    }

    function prevStep() {
      if (currentStep > 1) {
        showStep(currentStep - 1);
      }
    }

    // دالة إعادة تعيين النموذج لبدء قصة جديدة
    function resetForm() {
      // إعادة تعيين جميع الحقول
      document.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'checkbox' || el.type === 'radio') {
          el.checked = false;
        } else if (el.tagName === 'SELECT') {
          el.selectedIndex = 0;
        } else {
          el.value = '';
        }
      });

      // إزالة العناصر الديناميكية
      document.querySelectorAll('.list-item').forEach(el => el.remove());

      // إعادة تعيين الشرطيات
      document.getElementById('childrenField').style.display = 'none';
      document.getElementById('vitalsSection').style.display = 'none'; // إخفاء العلامات الحيوية
      const conditionalDetails = ['smokingDetails', 'alcoholDetails', 'drugsDetails'];
      conditionalDetails.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });

      // إخفاء النتائج إذا كانت موجودة
      document.getElementById('resultsSection').style.display = 'none';
      storySubmitted = false; // إعادة تعيين الحالة

      // العودة إلى Step 1
      currentStep = 1;
      showStep(1);

      alert('تم إعادة تعيين النموذج. يمكنك الآن بدء قصة سريرية جديدة.');
    }

    // Conditionals
    function toggleChildren() {
      const status = document.getElementById('maritalStatus').value;
      document.getElementById('childrenField').style.display = status !== 'أعزب' ? 'block' : 'none';
    }

    function toggleHabitDetails(detailsId) {
      const selectId = detailsId.replace('Details', '');
      const value = document.getElementById(selectId).value;
      const detailsEl = document.getElementById(detailsId);
      if (detailsEl) {
        detailsEl.style.display = value !== 'لا' ? 'block' : 'none';
      }
    }

    function toggleVitalsSection() {
      const optIn = document.getElementById('vitalsOptIn').value;
      document.getElementById('vitalsSection').style.display = optIn === 'نعم' ? 'block' : 'none';
    }

    function calculateBMI() {
      const weight = parseFloat(document.getElementById('weight').value);
      const height = parseFloat(document.getElementById('height').value) / 100;
      const bmi = weight && height ? (weight / (height * height)).toFixed(2) : '';
      document.getElementById('bmi').value = bmi;
    }

    // قوائم ديناميكية
    let medicalCount = 0, surgicalCount = 0, drugCount = 0, allergyCount = 0, familyCount = 0, reportCount = 0;

    function addMedicalHistory() {
      medicalCount++;
      const div = document.createElement('div');
      div.className = 'list-item';
      div.id = `medical${medicalCount}`;
      div.innerHTML = `
        <input type="text" placeholder="المَرْض" required>
        <input type="text" placeholder="المدة" required>
        <button class="remove-btn" onclick="removeItem('medical${medicalCount}')"><i class="fas fa-trash"></i></button>
      `;
      document.getElementById('medicalHistoryList').appendChild(div);
    }

    function addSurgicalHistory() {
      surgicalCount++;
      const div = document.createElement('div');
      div.className = 'list-item';
      div.id = `surgical${surgicalCount}`;
      div.innerHTML = `
        <input type="text" placeholder="العملية" required>
        <input type="text" placeholder="المدة" required>
        <button class="remove-btn" onclick="removeItem('surgical${surgicalCount}')"><i class="fas fa-trash"></i></button>
      `;
      document.getElementById('surgicalHistoryList').appendChild(div);
    }

    function addDrugHistory() {
      drugCount++;
      const div = document.createElement('div');
      div.className = 'list-item';
      div.id = `drug${drugCount}`;
      div.innerHTML = `
        <input type="text" placeholder="اسم الدواء" required>
        <input type="text" placeholder="الجرعة" required>
        <button class="remove-btn" onclick="removeItem('drug${drugCount}')"><i class="fas fa-trash"></i></button>
      `;
      document.getElementById('drugHistoryList').appendChild(div);
    }

    function addAllergyHistory() {
      allergyCount++;
      const div = document.createElement('div');
      div.className = 'list-item';
      div.id = `allergy${allergyCount}`;
      div.innerHTML = `
        <input type="text" placeholder="المادة" required>
        <input type="text" placeholder="نوع التفاعل" required>
        <select required><option value="">الشدة</option><option value="خفيف">خفيف</option><option value="متوسط">متوسط</option><option value="شديد">شديد</option></select>
        <button class="remove-btn" onclick="removeItem('allergy${allergyCount}')"><i class="fas fa-trash"></i></button>
      `;
      document.getElementById('allergyHistoryList').appendChild(div);
    }

    function addFamilyHistory() {
      familyCount++;
      const div = document.createElement('div');
      div.className = 'list-item';
      div.id = `family${familyCount}`;
      div.innerHTML = `
        <input type="text" placeholder="المَرْض" required>
        <select required><option value="">درجة القرابة</option><option value="أب">أب</option><option value="أم">أم</option><option value="أخ">أخ</option><option value="أخت">أخت</option><option value="جد">جد</option><option value="جدة">جدة</option><option value="أخرى">أخرى</option></select>
        <button class="remove-btn" onclick="removeItem('family${familyCount}')"><i class="fas fa-trash"></i></button>
      `;
      document.getElementById('familyHistoryList').appendChild(div);
    }

    // دالة إضافة تقرير (محدثة: بدون حقل رفع ملف)
    function addReport() {
      reportCount++;
      const div = document.createElement('div');
      div.className = 'list-item';
      div.id = `report${reportCount}`;
      div.innerHTML = `
        <select required><option value="">نوع التقرير</option><option value="X-RAY">X-RAY</option><option value="CT">CT</option><option value="MRI">MRI</option><option value="ECG">ECG</option><option value="Laboratory TEST">Laboratory TEST</option></select>
        <textarea placeholder="ملاحظات أو نتائج"></textarea>
        <button class="remove-btn" onclick="removeItem('report${reportCount}')"><i class="fas fa-trash"></i></button>
      `;
      document.getElementById('reportsList').appendChild(div);
    }

    function removeItem(id) {
      const element = document.getElementById(id);
      if (element) {
        element.remove();
      }
    }

    // دالة جمع البيانات في نص موجز لتقليل التوكنز
    function collectFormSummary() {
      const data = collectFormData(); // استخدم الدالة السابقة لجمع البيانات
      let summary = `المريض: ${data.patientInfo.name}، ${data.patientInfo.gender}، ${data.patientInfo.age} سنة، ${data.patientInfo.occupation || 'غير محدد'}، يسكن في ${data.patientInfo.address.trim()}. `;

      if (data.complaints.length > 0) {
        summary += `الشكايات الرئيسية: ${data.complaints.join('، ')}. `;
      }

      if (data.medicalHistory.length > 0) {
        summary += `السوابق المرضية: ${data.medicalHistory.map(m => `${m.disease} لمدة ${m.duration}`).join('، ')}. `;
      }

      if (data.surgicalHistory.length > 0) {
        summary += `السوابق الجراحية: ${data.surgicalHistory.map(s => `${s.surgery} لمدة ${s.duration}`).join('، ')}. `;
      }

      if (data.drugHistory.length > 0) {
        summary += `الأدوية الحالية: ${data.drugHistory.map(d => `${d.drug} ${d.dose}`).join('، ')}. `;
      }

      if (data.allergies.length > 0) {
        summary += `التحسسات: ${data.allergies.map(a => `${a.allergen} (${a.reaction})`).join('، ')}. `;
      }

      if (data.familyHistory.length > 0) {
        summary += `السوابق العائلية: ${data.familyHistory.map(f => `${f.disease} عند ${f.relation}`).join('، ')}. `;
      }

      summary += `العادات: التدخين ${data.habits.smoking} ${data.habits.smokingDetails ? `(${data.habits.smokingDetails})` : ''}، الكحول ${data.habits.alcohol} ${data.habits.alcoholDetails ? `(${data.habits.alcoholDetails})` : ''}، المخدرات ${data.habits.drugs} ${data.habits.drugsDetails ? `(${data.habits.drugsDetails})` : ''}. `;

      if (data.vitals.optIn === 'نعم' && data.vitals.bloodPressure) {
        summary += `العلامات الحيوية: ضغط ${data.vitals.bloodPressure}، نبض ${data.vitals.pulse}، حرارة ${data.vitals.temperature}، BMI ${data.vitals.bmi}. `;
      }

      if (data.reports.length > 0) {
        summary += `التقارير: ${data.reports.map(r => `${r.type}: ${r.notes}`).join('، ')}. `;
      }

      return summary;
    }

    // دالة جمع البيانات الأساسية (دون تغيير)
    function collectFormData() {
      const formData = {
        patientInfo: {
          name: document.getElementById('fullName').value,
          gender: document.getElementById('gender').value,
          age: document.getElementById('age').value,
          maritalStatus: document.getElementById('maritalStatus').value,
          children: document.getElementById('childrenCount').value || '0',
          address: document.getElementById('address').value,
          occupation: document.getElementById('occupation').value
        },
        complaints: Array.from(document.querySelectorAll('#complaintsList .list-item input:not([type="hidden"]), #complaintsList .list-item input[type="text"]')).map(input => input.value).filter(v => v.trim()),
        medicalHistory: Array.from(document.querySelectorAll('#medicalHistoryList .list-item input[type="text"]')).reduce((acc, input, idx) => {
          if (idx % 2 === 0) {
            const inputs = Array.from(document.querySelectorAll('#medicalHistoryList .list-item input[type="text"]'));
            acc.push({ disease: input.value, duration: inputs[idx + 1]?.value || '' });
          }
          return acc;
        }, []),
        surgicalHistory: Array.from(document.querySelectorAll('#surgicalHistoryList .list-item input[type="text"]')).reduce((acc, input, idx) => {
          if (idx % 2 === 0) {
            const inputs = Array.from(document.querySelectorAll('#surgicalHistoryList .list-item input[type="text"]'));
            acc.push({ surgery: input.value, duration: inputs[idx + 1]?.value || '' });
          }
          return acc;
        }, []),
        drugHistory: Array.from(document.querySelectorAll('#drugHistoryList .list-item input[type="text"]')).reduce((acc, input, idx) => {
          if (idx % 2 === 0) {
            const inputs = Array.from(document.querySelectorAll('#drugHistoryList .list-item input[type="text"]'));
            acc.push({ drug: input.value, dose: inputs[idx + 1]?.value || '' });
          }
          return acc;
        }, []),
        allergies: Array.from(document.querySelectorAll('#allergyHistoryList .list-item')).map(item => {
          const inputs = item.querySelectorAll('input[type="text"]');
          const select = item.querySelector('select');
          return { allergen: inputs[0]?.value, reaction: inputs[1]?.value, severity: select?.value };
        }).filter(a => a.allergen),
        familyHistory: Array.from(document.querySelectorAll('#familyHistoryList .list-item')).map(item => {
          const input = item.querySelector('input[type="text"]');
          const select = item.querySelector('select');
          return { disease: input?.value, relation: select?.value };
        }).filter(f => f.disease),
        habits: {
          smoking: document.getElementById('smoking').value,
          smokingDetails: document.getElementById('smokingQuantity').value,
          alcohol: document.getElementById('alcohol').value,
          alcoholDetails: document.getElementById('alcoholQuantity').value,
          drugs: document.getElementById('drugs').value,
          drugsDetails: document.getElementById('drugsQuantity').value
        },
        vitals: {
          optIn: document.getElementById('vitalsOptIn').value,
          bloodPressure: document.getElementById('bloodPressure').value,
          pulse: document.getElementById('pulse').value,
          temperature: document.getElementById('temperature').value,
          respiratoryRate: document.getElementById('respiratoryRate').value,
          weight: document.getElementById('weight').value,
          height: document.getElementById('height').value,
          bmi: document.getElementById('bmi').value
        },
        reports: Array.from(document.querySelectorAll('#reportsList .list-item')).map(item => {
          const select = item.querySelector('select');
          const textarea = item.querySelector('textarea');
          return { type: select?.value, notes: textarea?.value };
        }).filter(r => r.type)
      };

      return formData;
    }

    // دالة إرسال إلى puter.ai مع تحسين للتوكنز وعرض JSON كجدول
    async function sendToPuter() {
      const summary = collectFormSummary();
      const prompt = `بناءً على هذه الملخص القصة السريرية: ${summary}

قدم 3-5 تشخيصات تفريقية محتملة باللغة العربية، مع التركيز على الشكايات والسوابق والاستقصاءات. أرجع الإجابة فقط بتنسيق JSON صالح كالتالي:
[
  {
    "diagnosis": "التشخيص المحتمل",
    "reasons": "الأسباب الرئيسية من القصة",
    "recommendedTests": "الاستقصاءات المقترحة (شعاعية/مخبرية)",
    "probability": "عالية/متوسطة/منخفضة"
  }
]
لا تضف أي نص إضافي خارج JSON.`;

      try {
        const resultsSection = document.getElementById('resultsSection');
        const resultsDiv = document.getElementById('resultsTable');
        const nextBtn = document.getElementById('nextBtn');
        resultsSection.style.display = 'block';
        resultsDiv.innerHTML = '<p style="text-align: center;">جاري تحليل القصة السريرية... (قد يستغرق دقيقة)</p>';

        const resp = await puter.ai.chat(prompt, { model: 'gpt-5', stream: true });
        let fullResponse = '';
        for await (const part of resp) {
          fullResponse += part?.text || '';
        }

        // تنظيف الإجابة لاستخراج JSON فقط
        const jsonMatch = fullResponse.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
        if (!jsonMatch) {
          throw new Error('لم يتم إرجاع JSON صالح. الإجابة: ' + fullResponse.substring(0, 200));
        }

        const diagnoses = JSON.parse(jsonMatch[0]);
        if (!Array.isArray(diagnoses) || diagnoses.length === 0) {
          throw new Error('JSON غير صالح أو فارغ');
        }

        // بناء جدول HTML من JSON
        let tableHtml = `
          <table style="width: 100%; border-collapse: collapse; margin: 10px 0; direction: rtl; font-family: Tajawal, sans-serif;">
            <thead>
              <tr style="background: #007bff; color: white;">
                <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">التشخيص المحتمل</th>
                <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">الأسباب الرئيسية</th>
                <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">الاستقصاءات المقترحة</th>
                <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">الاحتمالية</th>
              </tr>
            </thead>
            <tbody>`;

        diagnoses.forEach(diag => {
          tableHtml += `
            <tr>
              <td style="border: 1px solid #ddd; padding: 10px; background: #f9f9f9;">${diag.diagnosis || ''}</td>
              <td style="border: 1px solid #ddd; padding: 10px;">${diag.reasons || ''}</td>
              <td style="border: 1px solid #ddd; padding: 10px;">${diag.recommendedTests || ''}</td>
              <td style="border: 1px solid #ddd; padding: 10px; font-weight: bold;">${diag.probability || ''}</td>
            </tr>`;
        });

        tableHtml += `
            </tbody>
          </table>`;

        resultsDiv.innerHTML = tableHtml;

        // Scroll إلى الجدول تلقائيًا لتحسين التجربة
        setTimeout(() => {
          resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300);

        // تحويل الزر بعد عرض النتائج
        storySubmitted = true;
        nextBtn.innerHTML = '<i class="fas fa-plus"></i> بدء قصة سريرية جديدة';
        nextBtn.onclick = resetForm;

      } catch (error) {
        console.error('خطأ في puter.ai:', error);
        const resultsDiv = document.getElementById('resultsTable');
        resultsDiv.innerHTML = `<p style="text-align: center; color: red;">خطأ في تحليل القصة: ${error.message}. تحقق من البيانات أو جرب مرة أخرى.</p>`;
      }
    }

    // Dark Mode تلقائي
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
    }
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    applyTheme(prefersDark ? 'dark' : 'light');
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => applyTheme(e.matches ? 'dark' : 'light'));

    // === نظام الموسوعة والأسئلة التفاعلية === //
    
    // بيانات الأعراض (مثال بسيط، يمكن توسيعها)
    let symptomsData = {
        "ألم في الصدر": {
            "description": "ألم في منطقة الصدر، قد يشير إلى أزمة قلبية، التهاب رئوي، أو مشاكل هضمية.",
            "questions": [
                { "text": "متى بدأ الألم؟", "type": "select", "options": ["أقل من ساعة", "1-24 ساعة", "1-7 أيام", "أسابيع", "أشهر", "سنوات"] },
                { "text": "هل ينتشر إلى الذراع أو الفك أو الكتف؟", "type": "checkbox", "options": ["ذراع يسار", "فك", "كتف", "ظهر", "لا ينتشر"] },
                { "text": "ما شدة الألم (من 1 إلى 10)؟", "type": "range", "min": 1, "max": 10, "step": 1 },
                { "text": "نوع الألم (حارق، طعني، ضغط)؟", "type": "select", "options": ["حارق", "طعني", "ضغط", "نبضي", "آخرى"] },
                { "text": "هل هناك ضيق تنفس أو غثيان أو عرق؟", "type": "checkbox", "options": ["ضيق تنفس", "غثيان", "عرق", "دوخة", "لا"] },
                { "text": "هل يزداد مع الجهد أو التنفس العميق؟", "type": "radio", "options": ["نعم", "لا"] },
                { "text": "المدة الإجمالية للحلقات السابقة؟", "type": "textarea" }
            ]
        }
        // يمكن إضافة المزيد هنا
    };

    // متغيرات لتخزين البيانات
    let currentSymptom = '';
    let questionAnswers = {};

    // فتح نافذة الموسوعة
    function openSymptomsLibrary() {
        const modal = document.getElementById('symptomsModal');
        if (modal) modal.style.display = 'block';
        loadSymptomsList();
    }

    // إغلاق نافذة الموسوعة
    function closeSymptomsModal() {
        const modal = document.getElementById('symptomsModal');
        if (modal) modal.style.display = 'none';
    }

    // تحميل قائمة الأعراض
    function loadSymptomsList() {
        const symptomsList = document.getElementById('symptomsList');
        if (!symptomsList) return;
        
        symptomsList.innerHTML = '';
        
        let count = 0;
        Object.keys(symptomsData).forEach(symptom => {
            count++;
            const symptomItem = document.createElement('div');
            symptomItem.className = 'symptom-item';
            symptomItem.innerHTML = `
                <h4>${symptom}</h4>
                <p>${symptomsData[symptom].description}</p>
            `;
            symptomItem.onclick = () => selectSymptom(symptom);
            symptomsList.appendChild(symptomItem);
        });
        
        const countEl = document.getElementById('symptomsCount');
        if (countEl) countEl.textContent = count;
    }

    // تصفية الأعراض
    function filterSymptoms() {
        const searchTerm = document.getElementById('symptomSearch')?.value.toLowerCase() || '';
        const symptoms = document.querySelectorAll('.symptom-item');
        let visibleCount = 0;
        
        symptoms.forEach(symptom => {
            const text = symptom.textContent.toLowerCase();
            const isVisible = text.includes(searchTerm);
            symptom.style.display = isVisible ? 'block' : 'none';
            if (isVisible) visibleCount++;
        });
        
        const countEl = document.getElementById('symptomsCount');
        if (countEl) countEl.textContent = visibleCount;
    }

    // اختيار عرض وفتح نافذة الأسئلة
    function selectSymptom(symptomName) {
        closeSymptomsModal();
        openSymptomQuestions(symptomName);
    }

    // فتح نافذة الأسئلة
    function openSymptomQuestions(symptomName) {
        currentSymptom = symptomName;
        questionAnswers = {};
        
        const modal = document.getElementById('questionsModal');
        const symptomData = symptomsData[symptomName];
        if (!modal || !symptomData) return;
        
        document.getElementById('symptomTitle').textContent = symptomName;
        document.getElementById('symptomDescription').textContent = symptomData.description;
        
        createQuestions(symptomData.questions);
        
        modal.style.display = 'block';
    }

    // إنشاء الأسئلة في النافذة
    function createQuestions(questions) {
        const container = document.getElementById('questionsContainer');
        if (!container) return;
        container.innerHTML = '';
        
        questions.forEach((question, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item';
            questionDiv.innerHTML = `
                <label>${question.text}</label>
                ${createQuestionInput(question, index)}
            `;
            container.appendChild(questionDiv);
        });
    }

    // إنشاء حقل الإدخال المناسب لكل سؤال
    function createQuestionInput(question, index) {
        switch(question.type) {
            case 'select':
                return `
                    <select onchange="saveAnswer(${index}, this.value)">
                        <option value="">اختر</option>
                        ${question.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>
                `;
            case 'checkbox':
                return `
                    <div class="checkbox-group">
                        ${question.options.map(opt => `
                            <label><input type="checkbox" onchange="saveCheckboxAnswer(${index}, '${opt.replace(/'/g, "\\'")}', this.checked)"> ${opt}</label>
                        `).join('')}
                    </div>
                `;
            case 'radio':
                return `
                    <div class="radio-group">
                        ${question.options.map(opt => `
                            <label><input type="radio" name="q${index}" onchange="saveAnswer(${index}, '${opt.replace(/'/g, "\\'")}')"> ${opt}</label>
                        `).join('')}
                    </div>
                `;
            case 'range':
                return `
                    <input type="range" min="${question.min}" max="${question.max}" step="${question.step}" 
                           oninput="document.getElementById('rangeValue${index}') && (document.getElementById('rangeValue${index}').textContent = this.value); saveAnswer(${index}, this.value)">
                    <span id="rangeValue${index}">${question.min}</span>
                `;
            case 'textarea':
                return `<textarea onchange="saveAnswer(${index}, this.value)"></textarea>`;
            default:
                return `<input type="text" onchange="saveAnswer(${index}, this.value)">`;
        }
    }

    // حفظ إجابة سؤال
    function saveAnswer(index, value) {
        questionAnswers[index] = value;
    }

    // حفظ إجابة من نوع checkbox
    function saveCheckboxAnswer(index, option, isChecked) {
        if (!questionAnswers[index]) questionAnswers[index] = [];
        if (isChecked) {
            if (!questionAnswers[index].includes(option)) questionAnswers[index].push(option);
        } else {
            questionAnswers[index] = questionAnswers[index].filter(item => item !== option);
        }
    }

    // إغلاق نافذة الأسئلة
    function closeQuestionsModal() {
        const modal = document.getElementById('questionsModal');
        if (modal) modal.style.display = 'none';
    }

    // إضافة الشكاية مع الإجابات
  function addSymptomWithAnswers() {
  const div = document.createElement('div');
  div.className = 'list-item';
  div.id = `complaint_${Date.now()}`;
  
  let summary = currentSymptom;
  if (Object.keys(questionAnswers).length > 0) {
    // البداية الجديدة - نص مفهوم للذكاء الاصطناعي
    summary += ": ";
    
    const symptomData = symptomsData[currentSymptom];
    const answers = Object.values(questionAnswers).filter(v => v);
    
    // ربط كل إجابة بسؤالها
    answers.forEach((answer, index) => {
      if (symptomData && symptomData.questions[index]) {
        const questionText = symptomData.questions[index].text.replace('؟', '').trim();
        summary += `${questionText} ${answer}، `;
      } else {
        // إذا لم يكن هناك سؤال معروف، نضيف الإجابة فقط
        summary += `${answer}، `;
      }
    });
    
    // إزالة last "، "
    summary = summary.slice(0, -2);
  }
  
  div.innerHTML = `
    <input type="text" value="${summary}" readonly style="background: var(--card-bg); cursor: not-allowed; flex: 1;">
    <button class="remove-btn" onclick="removeItem('${div.id}')"><i class="fas fa-trash"></i></button>
  `;
  document.getElementById('complaintsList').appendChild(div);
  
  closeQuestionsModal();
  showNotification(`تم إضافة "${currentSymptom}" إلى الشكايات`);
}
    // دالة لعرض إشعارات
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1001;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.remove(), 3000);
    }

    // إغلاق النوافذ عند النقر خارجها
    window.onclick = function(event) {
        if (event.target.id === 'symptomsModal') closeSymptomsModal();
        if (event.target.id === 'questionsModal') closeQuestionsModal();
    }

    // تهيئة
    updateProgress();
    showStep(1);
  </script>
  <!-- نافذة الموسوعة -->
  
<div id="symptomsModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-book-medical"></i> موسوعة الأعراض</h3>
            <span class="close" onclick="closeSymptomsModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="search-container">
                <input type="text" id="symptomSearch" placeholder="ابحث عن عرض..." onkeyup="filterSymptoms()">
            </div>
            <p>عدد الأعراض: <span id="symptomsCount">0</span></p>
            <div id="symptomsList" class="symptoms-list">
                <!-- سيتم ملء الأعراض هنا -->
            </div>
        </div>
    </div>
</div>
  <!-- نافذة الأسئلة التفاعلية -->
<div id="questionsModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-question-circle"></i> أسئلة تشخيصية: <span id="symptomTitle"></span></h3>
            <span class="close" onclick="closeQuestionsModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="symptomDescription" class="symptom-description" style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;"></div>
            <div id="questionsContainer" class="questions-container">
                <!-- سيتم ملء الأسئلة هنا -->
            </div>
            <div class="questions-controls" style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeQuestionsModal()" style="margin-left: 10px;">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button class="btn" onclick="addSymptomWithAnswers()">
                    <i class="fas fa-check"></i> إضافة الشكاية مع الإجابات
                </button>
            </div>
        </div>
    </div>
</div>
<style>
.modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
.modal-content { background-color: white; margin: 5% auto; padding: 0; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80%; overflow-y: auto; }
.modal-header { padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
.close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
.symptom-item { padding: 15px; border: 1px solid #ddd; margin: 10px 0; border-radius: 5px; cursor: pointer; background: #f9f9f9; }
.symptom-item:hover { background: #e9ecef; }
.questions-container { padding: 20px; }
.question-item { margin-bottom: 20px; }
.checkbox-group, .radio-group { display: flex; flex-direction: column; gap: 5px; }
@media (max-width: 600px) { .modal-content { width: 95%; margin: 10% auto; } }
</style>
</body>
</html>